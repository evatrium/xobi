import{useRef as e,useEffect as t,useCallback as n,useState as r}from"preact/hooks";const o=e=>"[object Object]"===Object.prototype.toString.call(e),c=e=>"function"==typeof e,s=(e,t,n)=>Object.defineProperty(e,t,n),u=e=>Object.keys(e),a=e=>!u(e).length,i=e=>o(e)||c(e),l=e=>i(e)&&e.$xobi,$=new Promise(e=>e()),h=e=>{let t=!1;return()=>(t||(t=$.then(()=>{e(),t=!1})),t)},p=(e,t)=>{for(let n in t)i(e[n])&&i(t[n])?p(e[n],t[n]):e[n]=t[n];return e},f=(e=[],t=(t=>e.splice(e.indexOf(t)>>>0,1)))=>[n=>(e.push(n),()=>t(n)),(...t)=>e.slice().map(e=>e(...t))],b=((e,t,n,r,b)=>{const g=()=>Object.create(null);return y=e=>o=>{const c=(()=>{const[,e]=b(g());return t(()=>{e(g())},[e])})(),s=!0===o,u=r(!0);return n(()=>()=>{u.current=!1},[]),n(()=>{const t=(0,(!s&&o?e.$select(o):e)[s?"$onAnyChange":"$onChange"])(()=>u.current&&c());return()=>t()},[]),e},(e,t={})=>{const n=!1===t.batch;let r={};const[b,g]=f(),m=()=>{!a(r)&&g(u(r)),r={}},x=n?m:h(m),j=(e,t="")=>{if(l(e))return e;const[g,m]=f(),C=()=>{const{$xobi:t}=e;!a(t.paths)&&m(u(t.paths)),t.paths={}},O={$xobi:{paths:{}},$use:y&&y(e),$notify:n?C:h(C),$onChange:e=>g(e),$onAnyChange:e=>b(e),$getState:()=>u(e).reduce((t,n)=>{let r=e[n],o=c(r);return l(r)?o&&a(r)||(t[n]=r.$getState()):o||(t[n]=r),t},{}),$merge:t=>(o(t)&&p(e,t),$),$select:t=>{const n={};return p(p(n,O),e),n.$onChange=n=>{const[r,o]=f(),c=r(n),s=e.$onAnyChange((e=[])=>{[].concat(t).some(t=>e.includes(t))&&o(e)});return()=>(s(),c())},n}};for(let t in O)s(e,t,{enumerable:!1,value:O[t]});for(let n in e){let c=e[n],u=t+(t?".":"")+n;i(c)&&j(e[n],u),s(e,n,{enumerable:!0,get:()=>c,set(t){if(t!==c){if("$"===n[0])return c=t;if(l(c)&&o(t))return p(e[n],t);c=t,r[u]=e.$xobi.paths[u]=!0,x(),e.$notify()}}})}return e};return j(e)};var y})(0,n,t,e,r);export default b;export{b as xobi};
